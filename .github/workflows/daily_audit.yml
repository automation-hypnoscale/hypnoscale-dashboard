name: Daily Refund Sweep

on:
  schedule:
    - cron: '0 4 * * *' # Runs at 4:00 AM UTC every day
  workflow_dispatch:    # Allows manual trigger

jobs:
  refund_sweep:
    runs-on: ubuntu-latest
    env:
      # ‚ö° CONFIGURATION
      SYNC_DAYS: "30"       # Look back 30 days
      SYNC_MODE: "REFUNDS"  # Only check for Refunds/Cancels (Fast)
      
      # üîê SECRETS (Same as hourly)
      CHECKOUT_CHAMP_ID: ${{ secrets.CHECKOUT_CHAMP_ID }}
      CHECKOUT_CHAMP_PASS: ${{ secrets.CHECKOUT_CHAMP_PASS }}
      NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv supabase

      - name: Run Refund Sweep
        run: python scripts/backfill_sales.py
